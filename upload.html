<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subir Recuerdo - Danko 53</title>
    <link href="/style.css" rel="stylesheet" type="text/css" media="all">
</head>
<body>
    <div class="parchment-bg">
        <header class="main-header">
            <div class="scout-emblem">âšœï¸</div>
            <h1 class="title-main">Libro de Oro</h1>
            <h2 class="title-sub">Danko 53</h2>
        </header>
        <nav class="main-nav">
            <a href="index.html" class="nav-link">ğŸ“– Ver Ãlbumes</a>
            <a href="upload.html" class="nav-link active">ğŸ“¤ Subir Recuerdo</a>
        </nav>
        <main class="content-main">
            <div id="passwordForm" class="password-container">
                <div class="lock-icon">ğŸ”</div>
                <h3>VerificaciÃ³n requerida</h3>
                <p>Ingresa la contraseÃ±a del grupo para subir recuerdos</p>
                <input type="password" id="passwordInput" placeholder="ContraseÃ±a..." class="password-input">
                <button onclick="verifyPassword()" class="btn-primary">Verificar</button>
                <p id="passwordError" class="error-message"></p>
            </div>
            <div id="uploadForm" class="upload-container" style="display: none;">
                <h3>âœ¨ Crear nuevo recuerdo</h3>
                <form id="albumForm">
                    <div class="form-group">
                        <label>ğŸ“ Nombre del Ã¡lbum/actividad *</label>
                        <input type="text" id="albumTitle" required placeholder="Ej: Campamento de Verano 2025">
                    </div>
                    <div class="form-group">
                        <label>ğŸ“… Fecha de la actividad *</label>
                        <input type="date" id="albumDate" required>
                    </div>
                    <div class="form-group">
                        <label>ğŸ“– DescripciÃ³n</label>
                        <textarea id="albumDescription" rows="4" placeholder="Cuenta la historia..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>ğŸ“ Archivos *</label>
                        <div class="file-upload-area" id="fileUploadArea">
                            <input type="file" id="fileInput" multiple accept="image/*,video/*,audio/*" hidden>
                            <div class="upload-placeholder">
                                <div class="upload-icon">ğŸ“</div>
                                <p>Haz clic o arrastra aquÃ­</p>
                                <span class="upload-hint">ImÃ¡genes, videos y audios (hasta 2 GB por archivo)</span>
                            </div>
                        </div>
                        <div id="filePreview" class="file-preview"></div>
                    </div>
                    <div class="upload-progress" id="uploadProgress" style="display: none;">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        <p id="progressText">Subiendo...</p>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn-primary btn-large">ğŸš€ Crear Ã¡lbum</button>
                        <button type="button" onclick="resetForm()" class="btn-secondary">Cancelar</button>
                    </div>
                </form>
            </div>
        </main>
    </div>

    <script type="module">
        const GIST_RAW_URL = 'https://gist.githubusercontent.com/gblsd/aba4eb5121fab803d603df4d76ee0d7b/raw/78d3c9d3d2fa5b40665e04cb21c0a59d9f4c410e/albums.json';

        const CORRECT_PASSWORD = "DankoPalmares53";
        let selectedFiles = [];

        window.verifyPassword = function() {
            const input = document.getElementById('passwordInput');
            const error = document.getElementById('passwordError');
           
            if (input.value === CORRECT_PASSWORD) {
                document.getElementById('passwordForm').style.display = 'none';
                document.getElementById('uploadForm').style.display = 'block';
                error.textContent = '';
            } else {
                error.textContent = 'âŒ ContraseÃ±a incorrecta.';
                input.value = '';
                input.focus();
            }
        };

        document.getElementById('passwordInput')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') verifyPassword();
        });

        document.addEventListener('DOMContentLoaded', () => {
            const fileUploadArea = document.getElementById('fileUploadArea');
            const fileInput = document.getElementById('fileInput');

            if (!fileUploadArea || !fileInput) {
                console.error('Elementos de subida no encontrados');
                return;
            }

            fileUploadArea.addEventListener('click', () => fileInput.click());
            fileUploadArea.addEventListener('dragover', e => {
                e.preventDefault();
                fileUploadArea.classList.add('dragover');
            });
            fileUploadArea.addEventListener('dragleave', () => fileUploadArea.classList.remove('dragover'));
            fileUploadArea.addEventListener('drop', e => {
                e.preventDefault();
                fileUploadArea.classList.remove('dragover');
                handleFiles(Array.from(e.dataTransfer.files));
            });
            fileInput.addEventListener('change', e => handleFiles(Array.from(e.target.files)));
        });

        function handleFiles(files) {
            selectedFiles = [...selectedFiles, ...files];
            displayFilePreview();
        }

        function displayFilePreview() {
            const preview = document.getElementById('filePreview');
            if (!preview) return;
            preview.innerHTML = '';
            selectedFiles.forEach((file, index) => {
                const item = document.createElement('div');
                item.className = 'file-item';
                let icon = 'ğŸ“„';
                if (file.type.startsWith('image/')) icon = 'ğŸ–¼ï¸';
                if (file.type.startsWith('video/')) icon = 'ğŸ¥';
                if (file.type.startsWith('audio/')) icon = 'ğŸµ';
                const size = (file.size / (1024 * 1024)).toFixed(2);
                item.innerHTML = `<span>${icon} ${file.name} (${size} MB)</span>
                                  <button onclick="removeFile(${index})" class="btn-remove">âœ•</button>`;
                preview.appendChild(item);
            });
        }

        window.removeFile = (index) => {
            selectedFiles.splice(index, 1);
            displayFilePreview();
        };

        window.resetForm = () => {
            document.getElementById('albumForm').reset();
            selectedFiles = [];
            displayFilePreview();
            window.location.href = 'index.html';
        };

        document.getElementById('albumForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (selectedFiles.length === 0) return alert('Selecciona al menos un archivo');

            const title = document.getElementById('albumTitle').value;
            const date = document.getElementById('albumDate').value;
            const description = document.getElementById('albumDescription').value;

            const progressDiv = document.getElementById('uploadProgress');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            progressDiv.style.display = 'block';

            try {
                progressText.textContent = 'Subiendo a tmpfiles.org...';

                const uploadedFiles = [];
                for (let i = 0; i < selectedFiles.length; i++) {
                    const file = selectedFiles[i];
                    progressText.textContent = `Subiendo ${i+1}/${selectedFiles.length}: ${file.name}...`;

                    const formData = new FormData();
                    formData.append('file', file);

                    const response = await fetch('https://tmpfiles.org/api/v1/upload', {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) throw new Error('tmpfiles fallÃ³ (status ' + response.status + ')');

                    const data = await response.json();
                    if (data.status !== 'success') throw new Error(data.message || 'Error desconocido');

                    const url = data.data.url.direct || data.data.url.viewer;

                    uploadedFiles.push({
                        name: file.name,
                        url: url,
                        type: file.type,
                        size: file.size
                    });

                    const progress = ((i + 1) / selectedFiles.length) * 100;
                    progressFill.style.width = progress + '%';
                }

                progressText.textContent = 'Preparando Ã¡lbum...';

                const newAlbum = {
                    id: Date.now().toString(),
                    title,
                    date,
                    description,
                    files: uploadedFiles,
                    created_at: new Date().toISOString()
                };

                const currentRes = await fetch(GIST_RAW_URL);
                if (!currentRes.ok) throw new Error('No se pudo leer Gist');

                let albums = await currentRes.json();
                if (!Array.isArray(albums)) albums = [];

                albums.push(newAlbum);

                const jsonString = JSON.stringify(albums, null, 2);
                alert('âœ… Â¡Subido!\n\n' +
                      'Copia este JSON y pÃ©galo en tu Gist:\n\n' +
                      jsonString + '\n\n' +
                      'Link Gist: https://gist.github.com/gblsd/aba4eb5121fab803d603df4d76ee0d7b/edit\n\n' +
                      'Reemplaza albums.json y guarda.');

                window.location.href = 'index.html';
            } catch (error) {
                console.error('Error:', error);
                alert('âŒ Error: ' + error.message + '\nRevisa consola (F12)');
            } finally {
                progressDiv.style.display = 'none';
            }
        });
    </script>
</body>
</html>


