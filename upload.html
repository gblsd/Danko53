<script type="module">
    // ==================== CONFIGURACI√ìN ====================
    const GIST_ID = 'TU_GIST_ID_AQUI';              // ‚Üê pon el ID del Gist
    const GITHUB_TOKEN = 'ghp_TU_TOKEN_AQUI';       // ‚Üê tu token personal
    const GIST_RAW_URL = `https://gist.githubusercontent.com/TU_USUARIO/${GIST_ID}/raw/albums.json`;

    // ==================== EL RESTO DEL C√ìDIGO ====================

    const CORRECT_PASSWORD = "DankoPalmares53";
    let selectedFiles = [];

    // Verificar contrase√±a (sin cambios)
    window.verifyPassword = function() {
        const input = document.getElementById('passwordInput');
        const error = document.getElementById('passwordError');
        if (input.value === CORRECT_PASSWORD) {
            document.getElementById('passwordForm').style.display = 'none';
            document.getElementById('uploadForm').style.display = 'block';
            error.textContent = '';
        } else {
            error.textContent = '‚ùå Contrase√±a incorrecta. Intenta de nuevo.';
            input.value = '';
            input.focus();
        }
    };

    document.getElementById('passwordInput')?.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') verifyPassword();
    });

    // Manejo de archivos (sin cambios)
    const fileUploadArea = document.getElementById('fileUploadArea');
    const fileInput = document.getElementById('fileInput');
    fileUploadArea.addEventListener('click', () => fileInput.click());
    fileUploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        fileUploadArea.classList.add('dragover');
    });
    fileUploadArea.addEventListener('dragleave', () => fileUploadArea.classList.remove('dragover'));
    fileUploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        fileUploadArea.classList.remove('dragover');
        handleFiles(Array.from(e.dataTransfer.files));
    });
    fileInput.addEventListener('change', (e) => handleFiles(Array.from(e.target.files)));

    function handleFiles(files) {
        selectedFiles = [...selectedFiles, ...files];
        displayFilePreview();
    }

    function displayFilePreview() {
        const preview = document.getElementById('filePreview');
        preview.innerHTML = '';
        selectedFiles.forEach((file, index) => {
            const item = document.createElement('div');
            item.className = 'file-item';
            let icon = 'üìÑ';
            if (file.type.startsWith('image/')) icon = 'üñºÔ∏è';
            if (file.type.startsWith('video/')) icon = 'üé•';
            if (file.type.startsWith('audio/')) icon = 'üéµ';
            const size = (file.size / (1024 * 1024)).toFixed(2);
            item.innerHTML = `
                <span>${icon} ${file.name} (${size} MB)</span>
                <button type="button" onclick="removeFile(${index})" class="btn-remove">‚úï</button>
            `;
            preview.appendChild(item);
        });
    }

    window.removeFile = function(index) {
        selectedFiles.splice(index, 1);
        displayFilePreview();
    };

    window.resetForm = function() {
        document.getElementById('albumForm').reset();
        selectedFiles = [];
        displayFilePreview();
        window.location.href = 'index.html';
    };

    // Enviar formulario - ESTA ES LA PARTE NUEVA
    document.getElementById('albumForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        if (selectedFiles.length === 0) {
            alert('Selecciona al menos un archivo');
            return;
        }

        const title = document.getElementById('albumTitle').value;
        const date = document.getElementById('albumDate').value;
        const description = document.getElementById('albumDescription').value;

        const progressDiv = document.getElementById('uploadProgress');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        progressDiv.style.display = 'block';

        try {
            // 1. Subir cada archivo a Catbox
            const uploadedFiles = [];
            for (let i = 0; i < selectedFiles.length; i++) {
                const file = selectedFiles[i];
                progressText.textContent = `Subiendo ${i+1}/${selectedFiles.length}: ${file.name}...`;

                const formData = new FormData();
                formData.append('reqtype', 'fileupload');
                formData.append('fileToUpload', file);

                const res = await fetch('https://catbox.moe/user/api.php', {
                    method: 'POST',
                    body: formData
                });

                if (!res.ok) throw new Error('Error subiendo a Catbox');

                const url = await res.text(); // URL directa de Catbox

                uploadedFiles.push({
                    name: file.name,
                    url: url,
                    type: file.type,
                    size: file.size
                });

                const progress = ((i + 1) / selectedFiles.length) * 100;
                progressFill.style.width = progress + '%';
            }

            // 2. Crear nuevo √°lbum
            const newAlbum = {
                id: Date.now().toString(),
                title,
                date,
                description,
                files: uploadedFiles,
                created_at: new Date().toISOString()
            };

            // 3. Leer el JSON actual desde Gist
            progressText.textContent = 'Guardando √°lbum...';
            const currentRes = await fetch(GIST_RAW_URL);
            let albums = await currentRes.json();
            if (!Array.isArray(albums)) albums = [];

            albums.push(newAlbum);

            // 4. Actualizar Gist
            const updateRes = await fetch(`https://api.github.com/gists/${GIST_ID}`, {
                method: 'PATCH',
                headers: {
                    'Authorization': `token ${GITHUB_TOKEN}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    files: {
                        'albums.json': {
                            content: JSON.stringify(albums, null, 2)
                        }
                    }
                })
            });

            if (!updateRes.ok) {
                const err = await updateRes.json();
                throw new Error(err.message || 'Error actualizando Gist');
            }

            alert('¬°√Ålbum creado exitosamente!');
            window.location.href = 'index.html';
        } catch (error) {
            console.error(error);
            alert('Error al crear el √°lbum: ' + error.message);
        } finally {
            progressDiv.style.display = 'none';
        }
    });
</script>

