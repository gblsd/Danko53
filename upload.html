<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subir Recuerdo - Danko 53</title>
    <link href="/style.css" rel="stylesheet" type="text/css" media="all">
</head>
<body>
    <div class="parchment-bg">
        <header class="main-header">
            <div class="scout-emblem">‚öúÔ∏è</div>
            <h1 class="title-main">Libro de Oro</h1>
            <h2 class="title-sub">Danko 53</h2>
        </header>

        <nav class="main-nav">
            <a href="index.html" class="nav-link">üìñ Ver √Ålbumes</a>
            <a href="upload.html" class="nav-link active">üì§ Subir Recuerdo</a>
        </nav>

        <main class="content-main">
            <!-- Formulario de verificaci√≥n de contrase√±a -->
            <div id="passwordForm" class="password-container">
                <div class="lock-icon">üîê</div>
                <h3>Verificaci√≥n requerida</h3>
                <p>Ingresa la contrase√±a del grupo para subir recuerdos</p>
                <input type="password" id="passwordInput" placeholder="Contrase√±a..." class="password-input">
                <button onclick="verifyPassword()" class="btn-primary">Verificar</button>
                <p id="passwordError" class="error-message"></p>
            </div>

            <!-- Formulario de subida (oculto inicialmente) -->
            <div id="uploadForm" class="upload-container" style="display: none;">
                <h3>‚ú® Crear nuevo recuerdo</h3>
                
                <form id="albumForm">
                    <div class="form-group">
                        <label>üìù Nombre del √°lbum/actividad *</label>
                        <input type="text" id="albumTitle" required placeholder="Ej: Campamento de Verano 2025">
                    </div>

                    <div class="form-group">
                        <label>üìÖ Fecha de la actividad *</label>
                        <input type="date" id="albumDate" required>
                    </div>

                    <div class="form-group">
                        <label>üìñ Descripci√≥n</label>
                        <textarea id="albumDescription" rows="4" placeholder="Cuenta la historia de este momento especial..."></textarea>
                    </div>

                    <div class="form-group">
                        <label>üìÅ Archivos (fotos, videos, audios) *</label>
                        <div class="file-upload-area" id="fileUploadArea">
                            <input type="file" id="fileInput" multiple accept="image/*,video/*,audio/*" hidden>
                            <div class="upload-placeholder">
                                <div class="upload-icon">üìé</div>
                                <p>Haz clic o arrastra archivos aqu√≠</p>
                                <span class="upload-hint">Im√°genes, videos y audios permitidos</span>
                            </div>
                        </div>
                        <div id="filePreview" class="file-preview"></div>
                    </div>

                    <div class="upload-progress" id="uploadProgress" style="display: none;">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        <p id="progressText">Subiendo archivos...</p>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn-primary btn-large">üöÄ Crear √°lbum</button>
                        <button type="button" onclick="resetForm()" class="btn-secondary">Cancelar</button>
                    </div>
                </form>
            </div>
        </main>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

        // CONFIGURACI√ìN DE SUPABASE - Reemplaza con tus datos
        const supabaseUrl = 'https://cughaowrzfyiivveorua.supabase.co';
        const supabaseKey = 'sb_publishable_vp0PYycdPpbmiYOnHazLVw_TgKXlQ_r';
        
        const supabase = createClient(supabaseUrl, supabaseKey);

        const CORRECT_PASSWORD = "DankoPalmares53";
        let selectedFiles = [];

        // Verificar contrase√±a
        window.verifyPassword = function() {
            const input = document.getElementById('passwordInput');
            const error = document.getElementById('passwordError');
            
            if (input.value === CORRECT_PASSWORD) {
                document.getElementById('passwordForm').style.display = 'none';
                document.getElementById('uploadForm').style.display = 'block';
                error.textContent = '';
            } else {
                error.textContent = '‚ùå Contrase√±a incorrecta. Intenta de nuevo.';
                input.value = '';
                input.focus();
            }
        };

        // Enter para verificar contrase√±a
        document.getElementById('passwordInput')?.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                verifyPassword();
            }
        });

        // Manejo de archivos - drag and drop
        const fileUploadArea = document.getElementById('fileUploadArea');
        const fileInput = document.getElementById('fileInput');

        fileUploadArea.addEventListener('click', () => fileInput.click());

        fileUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileUploadArea.classList.add('dragover');
        });

        fileUploadArea.addEventListener('dragleave', () => {
            fileUploadArea.classList.remove('dragover');
        });

        fileUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            fileUploadArea.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files);
            handleFiles(files);
        });

        fileInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            handleFiles(files);
        });

        function handleFiles(files) {
            selectedFiles = [...selectedFiles, ...files];
            displayFilePreview();
        }

        function displayFilePreview() {
            const preview = document.getElementById('filePreview');
            preview.innerHTML = '';

            selectedFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                
                let icon = 'üìÑ';
                if (file.type.startsWith('image/')) icon = 'üñºÔ∏è';
                else if (file.type.startsWith('video/')) icon = 'üé•';
                else if (file.type.startsWith('audio/')) icon = 'üéµ';

                const fileSize = (file.size / (1024 * 1024)).toFixed(2);

                fileItem.innerHTML = `
                    <span>${icon} ${file.name} (${fileSize} MB)</span>
                    <button type="button" onclick="removeFile(${index})" class="btn-remove">‚úï</button>
                `;
                preview.appendChild(fileItem);
            });
        }

        window.removeFile = function(index) {
            selectedFiles.splice(index, 1);
            displayFilePreview();
        };

        window.resetForm = function() {
            document.getElementById('albumForm').reset();
            selectedFiles = [];
            displayFilePreview();
            window.location.href = 'index.html';
        };

        // Enviar formulario
        document.getElementById('albumForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (selectedFiles.length === 0) {
                alert('Por favor selecciona al menos un archivo');
                return;
            }

            const title = document.getElementById('albumTitle').value;
            const date = document.getElementById('albumDate').value;
            const description = document.getElementById('albumDescription').value;

            const progressDiv = document.getElementById('uploadProgress');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            progressDiv.style.display = 'block';

            try {
                // Subir archivos a Supabase Storage
                const uploadedFiles = [];
                
                for (let i = 0; i < selectedFiles.length; i++) {
                    const file = selectedFiles[i];
                    const fileName = `${Date.now()}_${file.name}`;
                    const filePath = `albums/${fileName}`;
                    
                    progressText.textContent = `Subiendo archivo ${i + 1} de ${selectedFiles.length}: ${file.name}...`;
                    
                    // Subir archivo
                    const { data, error } = await supabase.storage
                        .from('albums')
                        .upload(filePath, file, {
                            cacheControl: '3600',
                            upsert: false
                        });

                    if (error) throw error;

                    // Obtener URL p√∫blica
                    const { data: urlData } = supabase.storage
                        .from('Albums')
                        .getPublicUrl(filePath);

                    uploadedFiles.push({
                        name: file.name,
                        path: filePath,
                        type: file.type,
                        size: file.size,
                        url: urlData.publicUrl
                    });

                    // Actualizar barra de progreso
                    const progress = ((i + 1) / selectedFiles.length) * 100;
                    progressFill.style.width = progress + '%';
                }

                // Guardar √°lbum en la base de datos
                progressText.textContent = 'Guardando √°lbum...';
                
                const { data: albumData, error: albumError } = await supabase
                    .from('albums')
                    .insert([
                        {
                            title: title,
                            date: date,
                            description: description,
                            files: uploadedFiles,
                            created_at: new Date().toISOString()
                        }
                    ])
                    .select();

                if (albumError) throw albumError;

                alert('‚úÖ ¬°√Ålbum creado exitosamente!');
                window.location.href = 'index.html';

            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå Error al subir el √°lbum: ' + error.message);
                progressDiv.style.display = 'none';
            }
        });
    </script>
</body>

</html>
